# 配線ガイド

Raspberry Pi Pico 2 W と オーディオ出力デバイスの配線方法を説明します。

## 目次

- [I2S DAC 出力モード（推奨）](#i2s-dac-出力モード推奨)
- [PWM 簡易 DAC 出力モード](#pwm-簡易-dac-出力モード)

---

## I2S DAC 出力モード（推奨）

I2S DAC モジュール（PCM5102A, UDA1334A など）を使用する場合の配線方法です。

### 対応 DAC モジュール

- **PCM5102A** (推奨): 高音質、設定不要、安価
- **UDA1334A**: Adafruit などから入手可能
- **MAX98357A**: デジタルアンプ内蔵（スピーカー直接駆動可能）
- その他 I2S 対応 DAC

### ピン配置表

#### デフォルト設定（`src/config.h`）

```c
#define I2S_DATA_PIN    26    // DIN (Data)
#define I2S_BCLK_PIN    27    // BCK (Bit Clock)
#define I2S_LRCLK_PIN   28    // LCK (Left/Right Clock / Word Select)
```

#### 配線表

| Pico 2 W GPIO | I2S 信号名 | PCM5102A ピン | 説明 |
|---------------|-----------|---------------|------|
| GPIO 26       | DATA      | DIN           | オーディオデータ |
| GPIO 27       | BCLK      | BCK           | ビットクロック |
| GPIO 28       | LRCLK     | LCK (LRCK)    | 左右チャンネルクロック |
| 3.3V (36番ピン) | VCC     | VIN / VCC     | 電源（3.3V） |
| GND (38番ピン)  | GND     | GND           | グランド |

### PCM5102A モジュールとの配線図

```
Raspberry Pi Pico 2 W              PCM5102A Module
┌─────────────────────┐           ┌──────────────┐
│                     │           │              │
│             GPIO 26 │───────────│ DIN          │
│             GPIO 27 │───────────│ BCK          │
│             GPIO 28 │───────────│ LCK          │
│                     │           │              │
│  3.3V (Pin 36) ─────│───────────│ VCC/VIN      │
│  GND  (Pin 38) ─────│───────────│ GND          │
│                     │           │              │
│                     │           │ XSMT ────────┤ 3.3V (※1)
│                     │           │ FLT  ────────┤ GND  (※2)
│                     │           │ DEMP ────────┤ GND  (※3)
│                     │           │ FMT  ────────┤ GND  (※4)
│                     │           │              │
└─────────────────────┘           │ OUTL ────────┤ スピーカー左
                                  │ AGND ────────┤ スピーカーGND
                                  │ OUTR ────────┤ スピーカー右
                                  └──────────────┘
```

**PCM5102A 設定ピン:**

- ※1 **XSMT (Mute)**: 3.3V に接続 = ミュート解除
- ※2 **FLT (Filter)**: GND に接続 = ノーマルフィルター
- ※3 **DEMP (De-emphasis)**: GND に接続 = De-emphasis 無効
- ※4 **FMT (Format)**: GND に接続 = I2S フォーマット

### Pico 2 W のピン配置図

```
        Raspberry Pi Pico 2 W (上面図)

        USB
        ┌───┐
        │   │
    ┌───┴───┴───┐
    │           │
  1 │ GP0       │ 40  VBUS
  2 │ GP1       │ 39  VSYS
  3 │ GND       │ 38  GND ──────> PCM5102A GND
  4 │ GP2       │ 37  3V3_EN
  5 │ GP3       │ 36  3V3 ──────> PCM5102A VCC
  : │ :         │ :
 33 │ GND       │ 31  GP26 ─────> PCM5102A DIN (DATA)
 34 │ GP27 ─────│────────────────> PCM5102A BCK (BCLK)
 35 │ GP28 ─────│────────────────> PCM5102A LCK (LRCLK)
 36 │ GP29      │ 29  GP22
 37 │ ADC_VREF  │ 28  GND
 38 │ 3V3       │ 27  GP21
 39 │ 3V3_EN    │ 26  GP20
 40 │ GND       │ 25  GP19
    └───────────┘
```

---

## PWM 簡易 DAC 出力モード

PWM を使った簡易的な DAC 出力です。音質は I2S より劣りますが、追加部品を最小限で済ませられます。

### デフォルト設定（`src/config.h`）

```c
#define PWM_AUDIO_PIN   26    // PWM 出力ピン
```

### 配線方法

#### 1. 最小構成（ローパスフィルタなし）

音質は悪いですが、動作確認には使えます。

```
Raspberry Pi Pico 2 W
┌─────────────────────┐
│                     │
│             GPIO 26 │────┬──────> ヘッドホン/スピーカー (+)
│                     │    │
│  GND  (Pin 38) ─────│────┴──────> ヘッドホン/スピーカー (-)
│                     │
└─────────────────────┘
```

⚠️ **警告**: 直接接続すると PWM ノイズが大きいため、必ずローパスフィルタを使用することを推奨します。

#### 2. 推奨構成（ローパスフィルタあり）

ノイズを減らすために、簡易的な RC ローパスフィルタを追加します。

**必要な部品:**
- 抵抗 1kΩ × 1
- コンデンサ 10μF × 1
- （オプション）抵抗 100Ω × 1（保護抵抗）

**回路図:**

```
Raspberry Pi Pico 2 W
┌─────────────────────┐
│                     │
│             GPIO 26 │────┬── 1kΩ ──┬──> ヘッドホン/スピーカー (+)
│                     │    │         │
│                     │    │       10μF
│                     │    │         │
│  GND  (Pin 38) ─────│────┴─────────┴──> ヘッドホン/スピーカー (-)
│                     │
└─────────────────────┘

カットオフ周波数: fc = 1 / (2π × R × C) ≈ 16 kHz
```

**詳細回路図（保護抵抗あり）:**

```
      Pico 2W                  ローパスフィルタ           出力
      ┌──────┐
GPIO26│      ├───100Ω───┬────1kΩ────┬─────────> ヘッドホン (+)
      └──────┘           │           │
                         │         10μF
      ┌──────┐           │           │
 GND  │      ├───────────┴───────────┴─────────> ヘッドホン (-)
      └──────┘
```

### モノラル/ステレオ出力

PWM モードはモノラル出力です。ステレオスピーカーに接続する場合は、L と R を並列接続してください。

```
PWM 出力 ──┬──> 左チャンネル
           └──> 右チャンネル
```

---

## 共通事項

### 電源について

- Pico 2 W への電源供給は **USB ケーブル**（5V）で行います
- I2S DAC には Pico の **3.3V ピン**から供給します
- 消費電流が大きい場合は、別電源を使用することを推奨します

### グランドの共通化

**重要**: Pico 2 W と DAC/スピーカーの GND は必ず共通接続してください。

### ピン番号の変更

`src/config.h` を編集することで、任意のピンに変更できます。

```c
// I2S モード
#define I2S_DATA_PIN    20    // 例: GPIO 20 に変更
#define I2S_BCLK_PIN    21
#define I2S_LRCLK_PIN   22

// PWM モード
#define PWM_AUDIO_PIN   15    // 例: GPIO 15 に変更
```

**注意事項:**
- I2S ピンは PIO0 に対応したピンを選択してください
- PWM ピンは PWM 機能が使えるピンを選択してください（ほとんどの GPIO で使用可能）

---

## トラブルシューティング

### 音が出ない

1. **配線を確認**
   - ピン番号が `src/config.h` の設定と一致しているか
   - GND が共通接続されているか
   - 電源が正しく供給されているか

2. **DAC モジュールの設定を確認**（I2S モード）
   - PCM5102A の XSMT ピンが 3.3V に接続されているか（ミュート解除）
   - FMT ピンが GND に接続されているか（I2S フォーマット）

3. **スピーカー/ヘッドホンを確認**
   - 別のデバイスで動作確認
   - 音量を上げる

### ノイズが多い

1. **PWM モードの場合**
   - ローパスフィルタを追加
   - 抵抗とコンデンサの値を調整（カットオフ周波数を下げる）

2. **I2S モードの場合**
   - 配線を短くする
   - シールドケーブルを使用
   - 電源にデカップリングコンデンサを追加（0.1μF）

### 音が歪む

- スピーカーのインピーダンスを確認（8Ω 以上推奨）
- 音量を下げる
- バッファサイズを増やす（`src/config.h` の `AUDIO_BUFFER_SIZE`）

---

## 参考資料

- [PCM5102A データシート](https://www.ti.com/product/PCM5102A)
- [Raspberry Pi Pico Pinout](https://datasheets.raspberrypi.com/pico/Pico-R3-A4-Pinout.pdf)
- [I2S 規格解説](https://en.wikipedia.org/wiki/I%C2%B2S)
