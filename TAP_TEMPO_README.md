# タップテンポ機能ガイド

## 概要

このプロジェクトには、ボタンタップからBPMを検出し、Beat-RepeatエフェクトとオンボードLEDを同期させるタップテンポ機能が実装されています。

## ハードウェア接続

### タップテンポボタン

```
Pico 2W                    タクトスイッチ
┌─────────┐
│  GPIO15 ├─────────┐
│         │         │
│     GND ├────┐    │
└─────────┘    │    │
               │    │
            ┌──┴────┴──┐
            │   ●   ●   │  タクトスイッチ
            └───────────┘
```

- **GPIO 15** ← ボタンの片側
- **GND** ← ボタンのもう片側
- **内部プルアップ有効** - 外部抵抗は不要

### I2S DAC接続（PCM5102Aなど）

```
Pico 2W          PCM5102A DAC
┌─────────┐     ┌──────────┐
│GPIO 26  ├─────┤ DIN      │
│GPIO 27  ├─────┤ BCK      │
│GPIO 28  ├─────┤ LCK      │
│  3.3V   ├─────┤ VIN      │
│   GND   ├─────┤ GND      │
└─────────┘     └──────────┘
```

## 使い方

### 1. タップテンポでBPMを設定

1. Bluetoothオーディオを接続して音楽を再生
2. 曲のリズムに合わせてボタンをタップ（2回以上）
3. BPMが自動的に検出され、エフェクトが同期
4. オンボードLED（Pico 2Wの緑LED）がBPMに合わせて点滅

### 2. BPMの検出

- **最小タップ数**: 2回（精度向上のため4回推奨）
- **BPM範囲**: 60-200 BPM
- **タップタイムアウト**: 2秒（この時間内にタップがないとリセット）

### 3. エフェクトの動作

#### デフォルト設定
- **音符分解能**: 16分音符
- **リピート回数**: 4回
- **ウェットミックス**: 70%

#### BPM検出後
- タップテンポで検出したBPMに基づいてスライス長が自動調整
- 例: BPM 120の場合
  - 4分音符 = 500ms
  - 16分音符 = 125ms ← エフェクトのスライス長

### 4. LED点滅パターン

- **点滅タイミング**: 4分音符ごと（1拍ごと）
- **点滅時間**: 50ms（短い点滅）
- **タップ時**: ボタンを押すたびに即座に点灯

## コードカスタマイズ

### 音符分解能の変更

現在は16分音符（デフォルト）ですが、変更可能です：

```c
// src/tap_tempo.c の tap_tempo_init() 内
state.note_division = NOTE_EIGHTH;  // 8分音符に変更
```

利用可能な値：
- `NOTE_WHOLE` - 全音符
- `NOTE_HALF` - 2分音符
- `NOTE_QUARTER` - 4分音符
- `NOTE_EIGHTH` - 8分音符
- `NOTE_SIXTEENTH` - 16分音符（デフォルト）
- `NOTE_THIRTY_SECOND` - 32分音符

### エフェクトパラメータの調整

```c
// src/audio_effect.c のデフォルト値を変更
#define DEFAULT_REPEAT_COUNT   8    // リピート回数を8回に
#define DEFAULT_WET_MIX        50   // ウェットミックスを50%に
```

### ボタンGPIOピンの変更

```c
// src/config.h
#define TAP_TEMPO_BUTTON_PIN  22  // GPIO 22に変更
```

## トラブルシューティング

### BPMが検出されない

- ボタンの接続を確認（GPIO 15とGNDに正しく接続）
- 2回以上タップしているか確認
- タップ間隔が2秒以内か確認

### LEDが点滅しない

- BPMが検出されているか確認（シリアル出力をチェック）
- `[TAP] BPM detected: XX.X` のメッセージが出ているか確認

### エフェクトがBPMに同期しない

- シリアル出力で `[EFFECT] Updated from tap tempo:` メッセージを確認
- BPMが60-200の範囲内か確認

## シリアル出力例

```
========================================
Tap Tempo Module
========================================
Button GPIO: 15
Default BPM: 120.0
Note Division: 16th note
Tap the button to set tempo!
========================================

[TAP] Button pressed at 5234 ms
[TAP] Button pressed at 5734 ms
[TAP] BPM detected: 120.0 (from 2 taps, avg interval: 500.0 ms)

[EFFECT] Updated from tap tempo:
  BPM: 120.0
  Slice length: 2756 samples (62.50 ms)
```

## パフォーマンス

- **CPU使用量**: タップテンポ処理は最小限（ポーリングベース）
- **レイテンシ**: BPM検出は即座（タップ直後）
- **メモリ**: 約200バイト（タップ履歴とステート）

## 今後の拡張予定

- [ ] ロータリーエンコーダで音符分解能を変更
- [ ] ロータリーエンコーダでリピート回数を調整
- [ ] ロータリーエンコーダでウェットミックスを調整
- [ ] ディスプレイで現在のBPMとパラメータを表示
